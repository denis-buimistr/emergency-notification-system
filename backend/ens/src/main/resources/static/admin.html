<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ENS ¬∑ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>

  <!-- Leaflet (–∫–∞—Ä—Ç–∞) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --blue:#1e40af;
      --blue2:#2563eb;
      --bg:#f8fafc;
      --card:#fff;
      --muted:#64748b;
      --border:#e2e8f0;
      --success:#16a34a;
      --danger:#dc2626;
    }

    * { box-sizing:border-box; }

    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background:var(--bg);
      color:#0f172a;
    }

    .shell{
      max-width:1100px;
      margin:32px auto;
      padding:0 16px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }

    .brand{
      font-weight:800;
      color:var(--blue);
      font-size:26px;
      letter-spacing:.3px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(15,23,42,0.05);
    }

    .toolbar{
      display:flex;
      gap:12px;
      align-items:center;
    }

    .btn{
      appearance:none;
      border:0;
      border-radius:10px;
      padding:10px 14px;
      font-weight:600;
      cursor:pointer;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:background .15s, transform .05s, box-shadow .15s;
    }

    .btn:active{
      transform:translateY(1px);
      box-shadow:none;
    }

    .btn.primary{
      background:var(--blue);
      color:#fff;
      box-shadow:0 8px 20px rgba(37,99,235,0.35);
    }

    .btn.primary:hover{ background:#1d4ed8; }

    .btn.secondary{
      background:#eef2ff;
      color:var(--blue);
    }

    .btn.secondary:hover{ background:#e0e7ff; }

    .btn.ghost{
      background:transparent;
      border:1px solid var(--border);
      color:#0f172a;
    }

    .btn.ghost:hover{ background:#f1f5f9; }

    .btn.success{
      background:var(--success);
      color:#fff;
    }

    .btn.success:hover{ background:#15803d; }

    .btn.danger{
      background:var(--danger);
      color:#fff;
    }

    .btn.danger:hover{ background:#b91c1c; }

    .grid{
      display:grid;
      gap:16px;
    }
    @media (min-width:980px){
      .grid{
        grid-template-columns:1.15fr 1fr;
      }
    }

    .section{
      padding:20px;
    }

    .section h2{
      margin:0 0 14px 0;
      color:var(--blue);
      font-size:20px;
    }

    .field{
      display:flex;
      flex-direction:column;
      margin-bottom:12px;
    }

    .label{
      font-size:13px;
      color:var(--muted);
      margin-bottom:6px;
    }

    .input,
    .select,
    textarea{
      padding:12px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      outline:none;
      font-size:14px;
      width:100%;
    }

    textarea{
      min-height:84px;
      resize:vertical;
    }

    .input:focus,
    .select:focus,
    textarea:focus{
      border-color:var(--blue2);
      box-shadow:0 0 0 1px rgba(37,99,235,0.35);
    }

    #map{
      height:340px;
      border-radius:12px;
      border:1px solid var(--border);
    }

    .list-head,
    .row{
      display:grid;
      grid-template-columns:130px 1fr 190px 120px 120px;
      gap:12px;
      align-items:center;
    }

    .list-head{
      color:var(--muted);
      font-size:13px;
      padding:10px 14px;
      border-bottom:1px solid var(--border);
    }

    .row{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      font-size:14px;
    }

    .status{
      font-weight:700;
    }
    .status.active{ color:#0ea5e9; }
    .status.resolved{ color:var(--success); }

    .muted{ color:var(--muted); }

    .hint{
      font-size:12px;
      color:var(--muted);
    }

    .actions{
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }

    .list-empty{
      padding:14px;
      font-size:14px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">ENS ¬∑ Admin</div>
      <div class="toolbar">
        <button class="btn ghost" onclick="logout()">–í—ã–π—Ç–∏</button>
      </div>
    </header>

    <div class="grid">
      <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: —Å–æ–∑–¥–∞–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞ -->
      <div class="card section">
        <h2>–°–æ–∑–¥–∞—Ç—å –∞–ª–µ—Ä—Ç</h2>

        <div class="field">
          <label class="label">–¢–∏–ø</label>
          <select id="type" class="select">
            <option value="fire">–ü–æ–∂–∞—Ä</option>
            <option value="accident">–î–¢–ü</option>
            <option value="flood">–ù–∞–≤–æ–¥–Ω–µ–Ω–∏–µ</option>
            <option value="gas">–£—Ç–µ—á–∫–∞ –≥–∞–∑–∞</option>
            <option value="other">–î—Ä—É–≥–æ–µ</option>
          </select>
        </div>

        <div class="field">
          <label class="label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
          <textarea id="message" class="input"
            placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å"></textarea>
        </div>

        <div class="field">
          <label class="label">–ê–¥—Ä–µ—Å (–º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –æ–±–ª–∞—Å—Ç—å/—É–ª–∏—Ü—É)</label>   
          <input id="address" class="input"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∏—à–∏–Ω—ë–≤, Cuza-Voda 34/2" />
          <div class="hint">
            –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.
            –ê–¥—Ä–µ—Å –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∫–∞—Ä—Ç–µ.
          </div>
        </div>

        <div style="display:flex; gap:8px; margin:10px 0 14px; flex-wrap:wrap;">
          <button class="btn secondary" onclick="geocodeAddress()">–ù–∞–π—Ç–∏ –ø–æ –∞–¥—Ä–µ—Å—É</button>
          <button class="btn ghost" onclick="useMyLocation()">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
          <button class="btn ghost" onclick="clearMarker()">–°–±—Ä–æ—Å–∏—Ç—å —Ç–æ—á–∫—É</button>
        </div>

        <div id="map" class="card" style="overflow:hidden"></div>
        <div class="hint" style="margin-top:8px">
          –ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        </div>

        <input type="hidden" id="lat" />
        <input type="hidden" id="lng" />

        <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end;">
          <button class="btn primary" onclick="createAlert()">–°–æ–∑–¥–∞—Ç—å –∞–ª–µ—Ä—Ç</button>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: —Å–ø–∏—Å–æ–∫ -->
      <div class="card section">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
          <h2 style="margin-bottom:0;">–ê–∫—Ç–∏–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
          <button class="btn ghost" onclick="loadList()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <div class="list-head" style="margin-top:10px;">
          <div>–¢–∏–ø</div>
          <div>–°–æ–æ–±—â–µ–Ω–∏–µ</div>
          <div>–õ–æ–∫–∞—Ü–∏—è</div>
          <div>–°—Ç–∞—Ç—É—Å</div>
          <div style="text-align:right;">–î–µ–π—Å—Ç–≤–∏—è</div>
        </div>
        <div id="list"></div>
        <div class="hint" style="margin-top:8px">

        </div>
      </div>
    </div>
  </div>

  <script>
    const API = window.location.origin;            // https://localhost:8443
    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/auth.html';

    /* ------------------ –ö–ê–†–¢–ê ------------------ */

    const map = L.map('map').setView([47.0105, 28.8638], 12); // –ö–∏—à–∏–Ω—ë–≤
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let marker = null;

    map.on('click', (e) => {
      setPoint(e.latlng.lat, e.latlng.lng);
      reverseGeocode(e.latlng.lat, e.latlng.lng)
        .catch(() => {}); // –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∏–º
    });

    function setPoint(lat, lng){
      if (marker) marker.remove();
      marker = L.marker([lat, lng]).addTo(map);
      document.getElementById('lat').value = lat.toFixed(6);
      document.getElementById('lng').value = lng.toFixed(6);
    }

    function clearMarker(){
      if (marker) marker.remove();
      marker = null;
      document.getElementById('lat').value = '';
      document.getElementById('lng').value = '';
    }

    async function useMyLocation(){
      if (!navigator.geolocation){
        alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
        return;
      }
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 15);
        setPoint(latitude, longitude);
        await reverseGeocode(latitude, longitude).catch(() => {});
      }, () => alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã'));
    }

    // –ü—Ä—è–º–æ–π –≥–µ–æ–∫–æ–¥–∏–Ω–≥ (–∏–∑ –∞–¥—Ä–µ—Å–∞ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
    async function geocodeAddress(){
      const q = document.getElementById('address').value.trim();
      if (!q){
        alert('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å');
        return;
      }
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers:{'Accept-Language':'ru'} });
      const data = await res.json();
      if (!data.length){
        alert('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ —ç—Ç–æ–º—É –∞–¥—Ä–µ—Å—É');
        return;
      }
      const { lat, lon, display_name } = data[0];
      map.setView([+lat, +lon], 16);
      setPoint(+lat, +lon);
      // –æ–±–Ω–æ–≤–∏–º –∞–¥—Ä–µ—Å –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
      document.getElementById('address').value = display_name;
    }

    // –û–±—Ä–∞—Ç–Ω—ã–π –≥–µ–æ–∫–æ–¥–∏–Ω–≥ (–∏–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –∞–¥—Ä–µ—Å)
    async function reverseGeocode(lat, lng){
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
      const res = await fetch(url, { headers:{'Accept-Language':'ru'} });
      if (!res.ok) return;
      const data = await res.json();
      if (data && data.display_name){
        document.getElementById('address').value = data.display_name;
      }
    }

    /* ------------------ API: —Å–æ–∑–¥–∞–Ω–∏–µ / —Å–ø–∏—Å–æ–∫ / –¥–µ–π—Å—Ç–≤–∏—è ------------------ */

    async function createAlert(){
      const message = document.getElementById('message').value.trim();
      const type    = document.getElementById('type').value;
      const lat     = parseFloat(document.getElementById('lat').value);
      const lng     = parseFloat(document.getElementById('lng').value);

      if (!message){
        alert('–ó–∞–ø–æ–ª–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ');
        return;
      }
      if (Number.isNaN(lat) || Number.isNaN(lng)){
        alert('–£–∫–∞–∂–∏ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –∞–¥—Ä–µ—Å');
        return;
      }

      const body = { message, type, latitude: lat, longitude: lng };

      const res = await fetch(`${API}/api/notifications`, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer ' + token
        },
        body:JSON.stringify(body)
      });

      if (!res.ok){
        const t = await res.text();
        alert('‚ùå –û—à–∏–±–∫–∞: ' + t);
        return;
      }

      alert('‚úÖ –ê–ª–µ—Ä—Ç —Å–æ–∑–¥–∞–Ω –∏ —Ä–∞–∑–æ—Å–ª–∞–Ω');
      document.getElementById('message').value = '';
      // –æ—Å—Ç–∞–≤–∏–º –∞–¥—Ä–µ—Å –∏ –º–µ—Ç–∫—É ‚Äì —É–¥–æ–±–Ω–æ –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö –∞–ª–µ—Ä—Ç–æ–≤
      await loadList();
    }

    async function resolve(id){
      const res = await fetch(`${API}/api/notifications/${id}/resolve`, {
        method:'PUT',
        headers:{ 'Authorization':'Bearer '+token }
      });
      if (res.ok) loadList();
      else alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
    }

    // –£–î–ê–õ–ï–ù–ò–ï —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ù–£–ñ–ï–ù backend: DELETE /api/notifications/{id})
    async function removeNotification(id){
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) return;
      const res = await fetch(`${API}/api/notifications/${id}`, {
        method:'DELETE',
        headers:{ 'Authorization':'Bearer '+token }
      });
      if (res.ok) loadList();
      else{
        const t = await res.text();
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ' + t);
      }
    }

    function isSystemTestNotification(n){
      const type = (n.type || '').toUpperCase();
      const msg  = (n.message || '').toLowerCase();
      // —Ñ–∏–ª—å—Ç—Ä —Å—Ä–æ—á–Ω–æ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      return type.includes('–°–ò–°–¢–ï–ú–ê ENS') || msg.includes('—Ç–µ—Å—Ç–æ–≤');
    }

    async function loadList(){
      const res = await fetch(`${API}/api/notifications`, {
        headers:{ 'Authorization':'Bearer '+token }
      });
      if (!res.ok){
        document.getElementById('list').innerHTML =
          '<div class="list-empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</div>';
        return;
      }

      const data = await res.json();
      const box  = document.getElementById('list');
      box.innerHTML = '';

      // —É–±–∏—Ä–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ/—Å–∏—Å—Ç–µ–º–Ω—ã–µ
      const filtered = data.filter(n => !isSystemTestNotification(n));

      if (!filtered.length){
        box.innerHTML = '<div class="list-empty">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
        return;
      }

      filtered.forEach(n => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div class="muted">${n.type?.toUpperCase() || '-'}</div>
          <div>${n.message || '-'}</div>
          <div class="muted">
            ${isFinite(+n.latitude) && isFinite(+n.longitude)
              ? 'üìç ' + (+n.latitude).toFixed(5) + ', ' + (+n.longitude).toFixed(5)
              : '‚Äî'}
          </div>
          <div class="status ${n.status}">
            ${n.status === 'resolved' ? 'Resolved' : 'Active'}
          </div>
          <div class="actions">
            ${n.status === 'resolved'
              ? ''
              : `<button class="btn success" onclick="resolve(${n.id})" title="–ü–æ–º–µ—Ç–∏—Ç—å —Ä–µ—à—ë–Ω–Ω—ã–º">‚úì</button>`}
            <button class="btn danger" onclick="removeNotification(${n.id})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
          </div>
        `;
        box.appendChild(row);
      });
    }

    function logout(){
      localStorage.clear();
      location.href = '/auth.html';
    }

    loadList(); // –ø–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
  </script>
</body>
</html>
